# 3-Szint≈± Hierarchikus System Prompt - Haszn√°lati √ötmutat√≥

## üéØ √Åttekint√©s

A rendszer **3 szint≈± hierarchikus system prompt** rendszert haszn√°l:

```
üåê ALKALMAZ√ÅS SZINT≈∞ (Global/Application)
    ‚Üì Minden tenant √©s user √∂r√∂kli
üè¢ TENANT SZINT≈∞ (Company Policy)
    ‚Üì A tenant minden usere √∂r√∂kli
üë§ USER SZINT≈∞ (Personal Preferences)
    ‚Üì Konkr√©t user preferenci√°i
```

### Prompt √âp√≠t√©si Sorrend:

1. **Alkalmaz√°s prompt** - Alap viselked√©s, biztons√°gi ir√°nyelvek
2. **Tenant prompt** (ha van) - C√©g-specifikus policy, st√≠lus
3. **User prompt** (ha van) - Szem√©lyes preferenci√°k
4. **User context** - Aktu√°lis user adatai (n√©v, nyelv stb.)

---

## üìù 1. Alkalmaz√°s Szint≈± Prompt

### Hol tal√°lhat√≥?
`backend/config/prompts.py` ‚Üí `APPLICATION_SYSTEM_PROMPT` konstans

### Tartalom:
```python
APPLICATION_SYSTEM_PROMPT = """You are a helpful AI assistant in a multi-tenant internal chat system.
- Always maintain professional tone
- Prioritize user privacy and data security
- Follow company policies and guidelines
- Provide helpful, accurate, and concise responses
- This is a production environment - be careful with sensitive information"""
```

### M√≥dos√≠t√°s:
```bash
# Szerkeszd a f√°jlt
vi backend/config/prompts.py

# Rebuild backend
docker-compose up --build -d backend
```

---

## üè¢ 2. Tenant Szint≈± Prompt

### Adatb√°zis mez≈ë:
- T√°bla: `tenants`
- Mez≈ë: `system_prompt` (TEXT, nullable)

### Be√°ll√≠t√°s SQL-lel:

```sql
-- ACME Corp sz√°m√°ra: Form√°lis, business-oriented
UPDATE tenants 
SET system_prompt = 'ACME Corporation Guidelines:
- Use formal, professional language
- Focus on business value and ROI
- Emphasize security and compliance
- Always mention data privacy considerations'
WHERE key = 'acme_corp';

-- TechStart Inc: Startup, casual
UPDATE tenants 
SET system_prompt = 'TechStart Culture:
- Use casual, friendly tone
- Encourage innovation and creativity
- Move fast and iterate
- Technical jargon is welcome'
WHERE key = 'techstart_inc';
```

### Be√°ll√≠t√°s Python API-val (p√©lda):

```python
# backend/database/pg_init.py-ban hozz√°adhat√≥ √∫j f√ºggv√©ny:

def update_tenant_prompt(tenant_id: int, system_prompt: str):
    """Update tenant-level system prompt."""
    with get_db_connection() as conn:
        with conn.cursor() as cursor:
            cursor.execute("""
                UPDATE tenants 
                SET system_prompt = %s, updated_at = NOW()
                WHERE id = %s
            """, (system_prompt, tenant_id))
            conn.commit()
```

### P√©lda haszn√°lat:

```python
from database.pg_init import update_tenant_prompt

# ACME sz√°m√°ra business-oriented prompt
acme_prompt = """ACME Corporation AI Assistant Guidelines:
- Professional, formal communication style
- Focus on business metrics and KPIs
- Always consider legal and compliance implications
- Prioritize data security in all recommendations
- Use business terminology and industry-standard frameworks"""

update_tenant_prompt(tenant_id=1, system_prompt=acme_prompt)
```

---

## üë§ 3. User Szint≈± Prompt

### Adatb√°zis mez≈ë:
- T√°bla: `users`
- Mez≈ë: `system_prompt` (TEXT, nullable)

### Be√°ll√≠t√°s SQL-lel:

```sql
-- Alice (developer) sz√°m√°ra: Technikai, k√≥d-orient√°lt
UPDATE users 
SET system_prompt = 'Personal Preferences:
- Provide code examples in Python whenever possible
- Use technical terminology without oversimplification
- Include best practices and performance considerations
- Prefer functional programming patterns'
WHERE nickname = 'alice_j';

-- Bob (manager) sz√°m√°ra: High-level, business-focused
UPDATE users 
SET system_prompt = 'Personal Preferences:
- Provide high-level summaries before details
- Focus on business impact and resource allocation
- Use charts and visualizations concepts
- Avoid technical jargon unless necessary'
WHERE nickname = 'bob_s';
```

### Be√°ll√≠t√°s Python API-val:

```python
def update_user_prompt(user_id: int, system_prompt: str):
    """Update user-level system prompt."""
    with get_db_connection() as conn:
        with conn.cursor() as cursor:
            cursor.execute("""
                UPDATE users 
                SET system_prompt = %s
                WHERE user_id = %s
            """, (system_prompt, user_id))
            conn.commit()
```

---

## üîÑ Prompt Kombin√°l√°si P√©lda

### P√©lda: Alice (ACME Corp, Developer)

**Input adatok:**
- **Alkalmaz√°s prompt**: "Be professional, secure, helpful..."
- **Tenant prompt (ACME)**: "Use formal language, focus on ROI..."
- **User prompt (Alice)**: "Provide Python code examples, technical..."

**Gener√°lt System Prompt:**

```
You are a helpful AI assistant in a multi-tenant internal chat system.
- Always maintain professional tone
- Prioritize user privacy and data security
- Follow company policies and guidelines
- Provide helpful, accurate, and concise responses
- This is a production environment - be careful with sensitive information

COMPANY POLICY:
ACME Corporation Guidelines:
- Use formal, professional language
- Focus on business value and ROI
- Emphasize security and compliance
- Always mention data privacy considerations

USER PREFERENCES:
Personal Preferences:
- Provide code examples in Python whenever possible
- Use technical terminology without oversimplification
- Include best practices and performance considerations
- Prefer functional programming patterns

CURRENT USER:
You are currently chatting with Alice Johnson (nickname: alice_j, role: developer, email: alice@acme.com, preferred language: hu).
Respond in Hungarian.
```

---

## üß™ Tesztel√©s

### 1. Tenant Prompt Tesztel√©se

```sql
-- ACME sz√°m√°ra formal prompt
UPDATE tenants SET system_prompt = 'Always use formal "√ñn" form in Hungarian, business-focused' WHERE id = 1;

-- TechStart sz√°m√°ra casual prompt
UPDATE tenants SET system_prompt = 'Always use casual "te" form in Hungarian, startup vibe' WHERE id = 2;
```

Teszteld: Ugyanazon k√©rd√©sre (pl. "Magyar√°zd el mi az AI?") Alice (ACME) form√°lisan v√°laszol, Charlie (TechStart) k√∂tetlenebb√ºl.

### 2. User Prompt Tesztel√©se

```sql
-- Alice sz√°m√°ra: Code-heavy
UPDATE users SET system_prompt = 'Always include code examples, prefer Python' WHERE user_id = 1;

-- Bob sz√°m√°ra: Summary-focused
UPDATE users SET system_prompt = 'Provide executive summaries, avoid code' WHERE user_id = 2;
```

Teszteld: "How does a REST API work?" ‚Üí Alice k√≥dot kap, Bob bullet pointokat.

### 3. Debug Panelen Ellen≈ërz√©s

1. Nyisd meg a Debug panelt (üêõ ikon)
2. V√°laszd ki Alice-t
3. G√∂rgess le a **"üîÑ LangGraph √Ållapot T√∂mb"** szekci√≥hoz
4. Az els≈ë √ºzenet (‚öôÔ∏è System) tartalmazza a teljes hierarchikus promptot

---

## üö® Best Practices

### 1. Alkalmaz√°s Szint≈± Prompt
- ‚úÖ √Åltal√°nos viselked√©si ir√°nyelvek
- ‚úÖ Biztons√°gi √©s adatv√©delmi szab√°lyok
- ‚úÖ Minden user/tenant sz√°m√°ra relev√°ns
- ‚ùå NE legyen t√∫l specifikus vagy hossz√∫

### 2. Tenant Szint≈± Prompt
- ‚úÖ C√©g kult√∫ra, kommunik√°ci√≥s st√≠lus
- ‚úÖ Ipar√°g-specifikus ir√°nyelvek
- ‚úÖ Compliance k√∂vetelm√©nyek
- ‚ùå NE legyen user-specifikus inform√°ci√≥

### 3. User Szint≈± Prompt
- ‚úÖ Szem√©lyes preferenci√°k (k√≥d vs. sz√∂veg)
- ‚úÖ V√°lasz form√°tum ig√©nyek
- ‚úÖ Domain-specifikus knowledge
- ‚ùå NE legyen ellentmond√°s a tenant prompt-tal

### 4. Prompt Hossz
- Alkalmaz√°s: 200-300 karakter
- Tenant: 300-500 karakter
- User: 200-400 karakter
- **Total max**: ~1500 karakter (a token limit miatt)

---

## üìä Admin UI Javaslat (J√∂v≈ëbeli Feature)

### Tenant Admin Dashboard:
```
Tenant Settings > System Prompt
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Company AI Assistant Policy             ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Textarea: 500 chars max]              ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Current tokens: 45 / 200               ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Preview: [Show combined prompt button] ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Save] [Reset to Default]              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### User Profile Settings:
```
My Preferences > AI Assistant
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Personal AI Preferences                 ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚ñ° Include code examples                ‚îÇ
‚îÇ ‚ñ° Use technical terminology            ‚îÇ
‚îÇ ‚ñ° Provide step-by-step instructions    ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Custom instructions (optional):        ‚îÇ
‚îÇ [Textarea: 300 chars max]              ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Save]                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß Hibaelh√°r√≠t√°s

### Prompt nem jelenik meg
```sql
-- Ellen≈ërizd, hogy a mez≈ë l√©tezik-e
\d tenants
\d users

-- N√©zd meg az aktu√°lis √©rt√©keket
SELECT id, name, system_prompt FROM tenants;
SELECT user_id, nickname, system_prompt FROM users;
```

### T√∫l hossz√∫ prompt (token limit)
```python
# config/prompts.py-ban limit√°l√°s
def build_system_prompt(...):
    # V√°gd le, ha t√∫l hossz√∫
    MAX_TOTAL_LENGTH = 1500
    combined = "\n".join(prompt_parts)
    if len(combined) > MAX_TOTAL_LENGTH:
        logger.warning(f"System prompt truncated from {len(combined)} to {MAX_TOTAL_LENGTH}")
        return combined[:MAX_TOTAL_LENGTH] + "..."
    return combined
```

---

## ‚úÖ √ñsszefoglal√°s

A 3-szint≈± hierarchikus prompt rendszer lehet≈ëv√© teszi:

1. **K√∂zponti kontroll** - Alkalmaz√°s szint≈± szab√°lyok
2. **Tenant customiz√°ci√≥** - C√©g-specifikus viselked√©s
3. **User personaliz√°ci√≥** - Egy√©ni preferenci√°k

**P√©lda workflow:**
```
1. Admin be√°ll√≠tja az ACME tenant prompt-j√°t (formal, business)
2. Alice be√°ll√≠tja saj√°t prompt-j√°t (code examples, Python)
3. Alice chat-el ‚Üí Kap: formal + business + code + Python v√°laszokat
4. Bob (ugyanaz a tenant) chat-el ‚Üí Kap: formal + business, de nincs k√≥d
```

**Kimeneti prompt mindig: Application ‚Üí Tenant ‚Üí User ‚Üí Context**
