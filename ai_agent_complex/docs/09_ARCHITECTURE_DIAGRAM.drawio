<mxfile host="app.diagrams.net" modified="2026-01-14T00:00:00.000Z" agent="Draw.io" version="22.1.0">
  <diagram name="AI Agent Architecture" id="ai-agent-architecture">
    <mxGraphModel dx="1434" dy="844" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1400" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Title -->
        <mxCell id="title" value="AI Agent Architecture: RAG → LangGraph → MCP Tools → Memory" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=20;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="300" y="20" width="1000" height="40" as="geometry" />
        </mxCell>
        
        <!-- PHASE 1: PROMPT (User Input) -->
        <mxCell id="phase1-title" value="1. PROMPT PHASE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="200" height="40" as="geometry" />
        </mxCell>
        
        <!-- Frontend -->
        <mxCell id="frontend" value="&lt;b&gt;React Frontend&lt;/b&gt;&lt;br&gt;src/App.tsx&lt;br&gt;ChatInput.tsx&lt;br&gt;&lt;br&gt;User types message" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="40" y="140" width="200" height="100" as="geometry" />
        </mxCell>
        
        <!-- API Request -->
        <mxCell id="api-request" value="POST /chat&lt;br&gt;{message, user_id, session_id}" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="40" y="260" width="200" height="60" as="geometry" />
        </mxCell>
        
        <!-- Arrow: Frontend to API -->
        <mxCell id="arrow1" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;strokeWidth=2;" edge="1" parent="1" source="frontend" target="api-request">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- API Layer -->
        <mxCell id="api-layer" value="&lt;b&gt;FastAPI Controller&lt;/b&gt;&lt;br&gt;main.py&lt;br&gt;@app.post('/chat')&lt;br&gt;&lt;br&gt;Receives ChatRequest&lt;br&gt;Validates input" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="40" y="350" width="200" height="120" as="geometry" />
        </mxCell>
        
        <!-- Arrow: API Request to API Layer -->
        <mxCell id="arrow2" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;strokeWidth=2;" edge="1" parent="1" source="api-request" target="api-layer">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- ChatService -->
        <mxCell id="chat-service" value="&lt;b&gt;ChatService&lt;/b&gt;&lt;br&gt;chat_service.py&lt;br&gt;process_message()&lt;br&gt;&lt;br&gt;1. Load user profile&lt;br&gt;2. Load conversation history&lt;br&gt;3. Build Memory context&lt;br&gt;4. Call AIAgent.run()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="40" y="500" width="200" height="160" as="geometry" />
        </mxCell>
        
        <!-- Arrow: API Layer to ChatService -->
        <mxCell id="arrow3" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;strokeWidth=2;" edge="1" parent="1" source="api-layer" target="chat-service">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- PHASE 2: ACTION (Agent Decision & Tool Selection) -->
        <mxCell id="phase2-title" value="2. ACTION PHASE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="340" y="80" width="200" height="40" as="geometry" />
        </mxCell>
        
        <!-- RAG Pipeline (NEW) -->
        <mxCell id="rag-pipeline" value="&lt;b&gt;RAG Pipeline&lt;/b&gt;&lt;br&gt;rag_graph.py&lt;br&gt;&lt;br&gt;Nodes:&lt;br&gt;- query_rewrite: LLM rewriting&lt;br&gt;- retrieve: Vector search&lt;br&gt;- format: Build citations&lt;br&gt;&lt;br&gt;ChromaDB + OpenAI embeddings" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="280" y="140" width="220" height="160" as="geometry" />
        </mxCell>
        
        <!-- AIAgent (Updated) -->
        <mxCell id="ai-agent" value="&lt;b&gt;AdvancedAgentGraph&lt;/b&gt;&lt;br&gt;advanced_graph.py&lt;br&gt;&lt;br&gt;LangGraph StateGraph:&lt;br&gt;- AgentState (TypedDict)&lt;br&gt;- MAX_ITERATIONS = 20&lt;br&gt;- RAG integration&lt;br&gt;- MCP tool discovery&lt;br&gt;- Parallel execution" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="140" width="200" height="160" as="geometry" />
        </mxCell>
        
        <!-- MCP Tool Fetch (NEW) -->
        <mxCell id="mcp-fetch" value="&lt;b&gt;MCP Tool Discovery&lt;/b&gt;&lt;br&gt;agent.py&lt;br&gt;&lt;br&gt;Fetch AlphaVantage Tools:&lt;br&gt;- Stock quotes (GLOBAL_QUOTE)&lt;br&gt;- Commodities (WTI, BRENT, etc)&lt;br&gt;- Economic data (CPI, GDP)&lt;br&gt;&lt;br&gt;Fetch DeepWiki Tools:&lt;br&gt;- Wikipedia search&lt;br&gt;- Entity extraction" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="280" y="330" width="220" height="180" as="geometry" />
        </mxCell>
        
        <!-- Agent Decide No(Updated) -->
        <!-- Route Decision -->
        <mxCell id="route-decision" value="&lt;b&gt;_route_decision()&lt;/b&gt;&lt;br&gt;agent.py&lt;br&gt;&lt;br&gt;Check iteration_count (&lt; 20)&lt;br&gt;Route to:&lt;br&gt;- tool_* (single tool)&lt;br&gt;- parallel_tool_execution&lt;br&gt;- mcp_tool_execution&lt;br&gt;- agent_finalize" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="540" width="220" height="140" as="geometry" />
        </mxCell>
        
        <!-- Arrow: ChatService to RAG -->
        <mxCell id="arrow4" value="user message" style="endArrow=classic;html=1;exitX=1;exitY=0.25;entryX=0;entryY=0.5;strokeWidth=2;edgeStyle=orthogonalEdgeStyle;strokeColor=#6c8ebf;" edge="1" parent="1" source="chat-service" target="rag-pipeline">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Arrow: ChatService to MCP Fetch -->
        <mxCell id="arrow-fetch" value="init tools" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;strokeWidth=2;edgeStyle=orthogonalEdgeStyle;strokeColor=#82b366;dashed=1;" edge="1" parent="1" source="chat-service" target="mcp-fetch">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Arrow: AIAgent to Decide -->
        <mxCell id="arrow5" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;strokeWidth=2;" edge="1" parent="1" source="ai-agent" target="agent-decide">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Arrow: Decide to Route -->
        <mxCell id="arrow6" value="JSON decision" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;strokeWidth=2;" edge="1" parent="1" source="agent-decide" target="route-decision">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- PHASE 3: OBSERVATION (Tool Execution) -->
        <mxCell id="phase3-title" value="3. OBSERVATION PHASE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="640" y="80" width="200" height="40" as="geometry" />
        </mxCell>
        
        <!-- Tool Nodes -->
        <mxCell id="tool-nodes" value="&lt;b&gt;Tool Execution Nodes&lt;/b&gt;&lt;br&gt;agent.py: _create_tool_node()&lt;br&gt;&lt;br&gt;Executes selected tool:&lt;br&gt;- Extract parameters&lt;br&gt;- Call tool.execute()&lt;br&gt;- Create ToolCall record&lt;br&gt;- Append to tools_called&lt;br&gt;- Add result to messages" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="640" y="140" width="200" height="180" as="geometry" />
        </mxCell>
        
        <!-- Local Tool Wrappers (Updated) -->
        <mxCell id="tool-wrappers" value="&lt;b&gt;Tool Wrappers&lt;/b&gt;&lt;br&gt;tools.py&lt;br&gt;&lt;br&gt;- WeatherTool&lt;br&gt;- GeocodeTool&lt;br&gt;- IPGeolocationTool&lt;br&gt;- FXRatesTool&lt;br&gt;- CryptoPriceTool&lt;br&gt;- FileCreationTool&lt;br&gt;- HistorySearchTool&lt;br&gt;&lt;br&gt;Each has: name, description, execute()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="640" y="350" width="200" height="220" as="geometry" />
        </mxCell>
        
        <!-- API Clients -->
        <mxCell id="api-clients" value="&lt;b&gt;External API Clients&lt;/b&gt;&lt;br&gt;tool_clients.py&lt;br&gt;&lt;br&gt;- OpenMeteoWeatherClient&lt;br&gt;- NominatimGeocodeClient&lt;br&gt;- IPAPIGeolocationClient&lt;br&gt;- ExchangeRateHostClient (Frankfurter)&lt;br&gt;- CoinGeckoCryptoClient&lt;br&gt;&lt;br&gt;HTTP calls to external APIs" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="920" y="350" width="240" height="220" as="geometry" />
        </mxCell>
        
        <!-- Arrow: RAG to Agent -->
        <mxCell id="arrow-rag" value="RAG context" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;strokeWidth=2;strokeColor=#6c8ebf;edgeStyle=orthogonalEdgeStyle;" edge="1" parent="1" source="rag-pipeline" target="ai-agent">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Arrow: MCP Fetch to Agent Decide -->
        <mxCell id="arrow-mcp-fetch" value="tools list" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;strokeWidth=2;strokeColor=#82b366;edgeStyle=orthogonalEdgeStyle;" edge="1" parent="1" source="mcp-fetch" target="agent-decide">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Arrow: Route to Tools -->
        <mxCell id="arrow7" value="single tool" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.3;strokeWidth=2;edgeStyle=orthogonalEdgeStyle;strokeColor=#d79b00;" edge="1" parent="1" source="route-decision" target="tool-wrappers">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Arrow: Route to Parallel -->
        <mxCell id="arrow-parallel" value="call_tools_parallel" style="endArrow=classic;html=1;exitX=1;exitY=0.7;entryX=0;entryY=0.5;strokeWidth=3;strokeColor=#ff6600;edgeStyle=orthogonalEdgeStyle;fontStyle=1" edge="1" parent="1" source="route-decision" target="parallel-execution">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Arrow: Route to MCP -->
        <mxCell id="arrow-mcp" value="MCP tool" style="endArrow=classic;html=1;exitX=1;exitY=0.3;entryX=0;entryY=0.5;strokeWidth=2;strokeColor=#82b366;edgeStyle=orthogonalEdgeStyle;" edge="1" parent="1" source="route-decision" target="mcp-execution">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Arrow: Tools to Clients -->
        <mxCell id="arrow9" value="" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.3;strokeWidth=2;" edge="1" parent="1" source="tool-wrappers" target="api-clients">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Arrow: MCP to Clients -->
        <mxCell id="arrow-mcp-client" value="" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.7;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1" source="mcp-execution" target="api-clients">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Arrow: Parallel to Clients -->
        <mxCell id="arrow-parallel-client" value="" style="endArrow=classic;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;strokeWidth=2;strokeColor=#ff6600;" edge="1" parent="1" source="parallel-execution" target="api-clients">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Loop Back to Decide -->
        <mxCell id="arrow11" value="Loop: tools → agent_decide&lt;br&gt;(multi-step, iteration &lt; 20)" style="endArrow=classic;html=1;exitX=0.5;exitY=0;entryX=1;entryY=0.7;strokeWidth=3;strokeColor=#ff6600;edgeStyle=orthogonalEdgeStyle;" edge="1" parent="1" source="parallel-execution" target="agent-decide">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- PHASE 4: MEMORY(Updated) -->
        <mxCell id="agent-finalize" value="&lt;b&gt;agent_finalize_node()&lt;/b&gt;&lt;br&gt;agent.py&lt;br&gt;&lt;br&gt;Generate final response:&lt;br&gt;- Integrate all tool results&lt;br&gt;- Include RAG citations&lt;br&gt;- Return AIMessage" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="800" width="220" height="120" as="geometry" />
        </mxCell>
        
        <!-- Arrow: Route to Finalize -->
        <mxCell id="arrow12" value="if action == final_answer&lt;br&gt;OR iteration_count &gt;= MAX" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;strokeWidth=2;" edge="1" parent="1" source="route-decision" target="agent-finalize">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Repositories (Updated) -->
        <mxCell id="repositories" value="&lt;b&gt;Repositories&lt;/b&gt;&lt;br&gt;repositories.py&lt;br&gt;&lt;br&gt;FileUserRepository:&lt;br&gt;- save_profile()&lt;br&gt;- get_profile()&lt;br&gt;- data/users/*.json&lt;br&gt;&lt;br&gt;FileConversationRepository:&lt;br&gt;- add_message()&lt;br&gt;- get_history()&lt;br&gt;- data/sessions/*.json&lt;br&gt;&lt;br&gt;Vector Store (RAG):&lt;br&gt;- ChromaDB&lt;br&gt;- data/chroma/" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="40" y="800" width="240" height="240" as="geometry" />
        </mxCell>
        
        <!-- Profile Updates (Updated) -->
        <mxCell id="profile-updates" value="&lt;b&gt;Profile &amp; Memory Updates&lt;/b&gt;&lt;br&gt;chat_service.py&lt;br&gt;&lt;br&gt;Extract from conversation:&lt;br&gt;- User name (regex)&lt;br&gt;- City/location&lt;br&gt;- Preferences&lt;br&gt;&lt;br&gt;Save to user profile&lt;br&gt;&lt;br&gt;Observability:&lt;br&gt;- Prometheus metrics&lt;br&gt;- Request correlation (request_id)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="40" y="1070" width="240" height="200" as="geometry" />
        </mxCell>
        
        <!-- Arrow: ChatService back from Agent -->
        <mxCell id="arrow13" value="agent_result" style="endArrow=classic;html=1;exitX=0;exitY=0.5;entryX=1;entryY=0.75;strokeWidth=2;edgeStyle=orthogonalEdgeStyle;dashed=1;strokeColor=#999999;" edge="1" parent="1" source="agent-finalize" target="chat-service">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Arrow: ChatService to Repositories -->
        <mxCell id="arrow14" value="persist messages&lt;br&gt;and profile updates" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;strokeWidth=2;" edge="1" parent="1" source="chat-service" target="repositories">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Arrow: Repositories to Profile Updates -->
        <mxCell id="arrow15" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;strokeWidth=2;" edge="1" parent="1" source="repositories" target="profile-updates">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Response Flow -->
        <mxCell id="response-title" value="RESPONSE FLOW" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="640" y="720" width="200" height="40" as="geometry" />
        </mxCell>
        
        <!-- ChatResponse -->
        <mxCell id="chat-response" value="&lt;b&gt;ChatResponse&lt;/b&gt;&lt;br&gt;models.py&lt;br&gt;&lt;br&gt;- message: final_answer&lt;br&gt;- tools_used: List[ToolCall]&lt;br&gt;- memory_snapshot: preferences&lt;br&gt;- session_id&lt;br&gt;- timestamp" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="640" y="780" width="200" height="140" as="geometry" />
        </mxCell>
        
        <!-- API Response -->
        <mxCell id="api-response" value="&lt;b&gt;FastAPI Response&lt;/b&gt;&lt;br&gt;main.py&lt;br&gt;&lt;br&gt;JSON response to frontend" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="640" y="950" width="200" height="80" as="geometry" />
        </mxCell>
        
        <!-- Frontend Update -->
        <mxCell id="frontend-update" value="&lt;b&gt;Frontend Update&lt;/b&gt;&lt;br&gt;App.tsx&lt;br&gt;&lt;br&gt;- Display message&lt;br&gt;- Show tools used&lt;br&gt;- Update memory snapshot&lt;br&gt;- Append to chat history" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="640" y="1060" width="200" height="120" as="geometry" />
        </mxCell>
        
        <!-- Arrow: ChatResponse to API Response -->
        <mxCell id="arrow16" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;strokeWidth=2;" edge="1" parent="1" source="chat-response" target="api-response">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Arrow: API Response to Frontend -->
        <mxCell id="arrow17" value="" style="endArrow=classic;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=0;strokeWidth=2;" edge="1" parent="1" source="api-response" target="frontend-update">
          <mxGeometry width="50" height="50" relative="1" as="geometry" />
        </mxCell>
        
        <!-- Legend -->
        <mxCell id="legend-box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#666666;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="920" y="80" width="240" height="270" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-title" value="&lt;b&gt;LEGEND&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="920" y="85" width="240" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-1" value="RAG: Knowledge retrieval" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="120" width="220" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-2" value="Agent: LLM decision &amp; routing" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="150" width="220" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-3" value="MCP: Dynamic tool discovery" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="180" width="220" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-4" value="Local tools: Built-in functions" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="210" width="220" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-5" value="Memory: File &amp; vector persistence" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="240" width="220" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-6" value="Frontend: React UI" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="270" width="220" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-7" value="External: HTTP APIs &amp; MCP servers" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="300" width="220" height="25" as="geometry" />
        </mxCell>
        
        <!-- Key Classes Box -->
        <mxCell id="key-classes-box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#666666;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="920" y="620" width="240" height="560" as="geometry" />
        </mxCell>
        
        <mxCell id="key-classes-title" value="&lt;b&gt;KEY CLASSES &amp; FILES&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="920" y="625" width="240" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="key-classes-content" value="&lt;b&gt;RAG PIPELINE:&lt;/b&gt;&lt;br&gt;- create_rag_subgraph() (rag_graph.py)&lt;br&gt;- RetrievalService&lt;br&gt;- ChromaVectorStore&lt;br&gt;- OpenAIEmbeddingService&lt;br&gt;- OverlappingChunker&lt;br&gt;- query_rewrite, retrieve, format nodes&lt;br&gt;&lt;br&gt;&lt;b&gt;AGENT CORE:&lt;/b&gt;&lt;br&gt;- AdvancedAgentGraph (advanced_graph.py)&lt;br&gt;- AgentState (state.py - TypedDict)&lt;br&gt;- AdvancedAgentAdapter (main.py)&lt;br&gt;- _agent_decide_node()&lt;br&gt;- _fetch_alphavantage_tools_node()&lt;br&gt;- _fetch_deepwiki_tools_node()&lt;br&gt;- _route_decision()&lt;br&gt;- MAX_ITERATIONS = 20&lt;br&gt;&lt;br&gt;&lt;b&gt;MCP INTEGRATION:&lt;/b&gt;&lt;br&gt;- MCPClient (tool_clients.py)&lt;br&gt;- DeepWikiMCPClient&lt;br&gt;- mcp_tool_execution_node()&lt;br&gt;- AlphaVantage MCP server&lt;br&gt;- DeepWiki MCP server&lt;br&gt;&lt;br&gt;&lt;b&gt;PARALLEL EXECUTION:&lt;/b&gt;&lt;br&gt;- execute_parallel_mcp_tools()&lt;br&gt;- parallel_tool_execution_node()&lt;br&gt;- asyncio.gather()&lt;br&gt;- parallel_results_reducer()&lt;br&gt;&lt;br&gt;&lt;b&gt;LOCAL TOOLS:&lt;/b&gt;&lt;br&gt;- WeatherTool, GeocodeTool&lt;br&gt;- CryptoPriceTool, FXRatesTool&lt;br&gt;- FileCreationTool&lt;br&gt;- HistorySearchTool&lt;br&gt;&lt;br&gt;&lt;b&gt;MEMORY:&lt;/b&gt;&lt;br&gt;- FileUserRepository&lt;br&gt;- FileConversationRepository&lt;br&gt;- ChromaVectorStore (RAG)&lt;br&gt;&lt;br&gt;&lt;b&gt;OBSERVABILITY:&lt;/b&gt;&lt;br&gt;- Prometheus metrics&lt;br&gt;- request_id correlation&lt;br&gt;- record_node_duration()&lt;br&gt;- record_error()" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="930" y="660" width="220" height="510" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
